---
import { Image } from "astro:assets";
interface Props {
    images: any[];
}

const { images } = Astro.props;
---

<div class="carousel-container" data-images-count={images.length}>
    <div class="carousel-track">
        {
            images.map((img, index) => (
                <div class="carousel-slide" data-index={index}>
                    <Image src={img} alt="" />
                </div>
            ))
        }
    </div>
</div>

<script>
    function initCarousels() {
        const containers = document.querySelectorAll(".carousel-container");

        containers.forEach((container) => {
            if (container.hasAttribute("data-initialized")) return;
            container.setAttribute("data-initialized", "true");

            const count = parseInt(
                container.getAttribute("data-images-count") || "0",
            );

            // Determine visible slides based on container aspect ratio
            const updateVisibleSlides = () => {
                if (container.clientHeight === 0) return 1;
                return Math.round(container.clientWidth / container.clientHeight);
            };

            let visibleSlides = updateVisibleSlides();
            (container as HTMLElement).style.setProperty(
                "--carousel-slides-visible",
                visibleSlides.toString(),
            );

            // Observe resize to update visible slides
            const resizeObserver = new ResizeObserver(() => {
                visibleSlides = updateVisibleSlides();
                (container as HTMLElement).style.setProperty(
                    "--carousel-slides-visible",
                    visibleSlides.toString(),
                );
            });
            resizeObserver.observe(container);

            if (count <= 1) {
                // Even if count <= 1, strictly we might just want to show it.
                // But the existing logic returned here.
                // We should ensure styles are correct for 1 item.
                (container as HTMLElement).style.setProperty(
                    "--carousel-slides-visible",
                    "1",
                );
                return;
            }

            const track = container.querySelector(
                ".carousel-track",
            ) as HTMLElement;
            let currentIndex = 0;

            const updateCarousel = () => {
                // If we have enough space for all images, reset to start
                if (count <= visibleSlides) {
                    currentIndex = 0;
                    if (track) track.style.transform = `translateX(0%)`;
                    return;
                }

                const maxIndex = count - visibleSlides;
                const step = 100 / visibleSlides;

                currentIndex += 1;

                if (currentIndex > maxIndex) {
                    // Slide quickly back to start
                    track.style.transition = "transform 0.5s ease-in-out";
                    track.style.transform = `translateX(0%)`;
                    currentIndex = 0;
                    // Restore normal transition after the fast return completes
                    setTimeout(() => {
                        track.style.transition = "";
                    }, 300);
                    return;
                }

                track.style.transition = "";
                track.style.transform = `translateX(-${currentIndex * step}%)`;
            };

            setInterval(updateCarousel, 5000);
        });
    }

    document.addEventListener("DOMContentLoaded", initCarousels);
    document.addEventListener("astro:page-load", initCarousels);

    if (
        document.readyState === "interactive" ||
        document.readyState === "complete"
    ) {
        initCarousels();
    }
</script>

<style>
    .carousel-container {
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
        display: block;
    }

    .carousel-track {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform 0.5s ease-in-out;
    }

    .carousel-slide {
        flex: 0 0 calc(100% / var(--carousel-slides-visible, 1));
        width: calc(100% / var(--carousel-slides-visible, 1));
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    img {
        height: 100%;
        width: auto;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        display: block;
    }
</style>
